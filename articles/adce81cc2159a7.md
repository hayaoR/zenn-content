---
title: "RustにおけるVariance(変性)をふんわり理解する"
emoji: "🦀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["rust", "variance"]
published: false
---

# はじめに
Rustの学習を進めていくと`Variance(変性)`という概念に出会うと思います。多分これは学術的なもので正確に理解するのは難しそうです。少なくとも私はふわっとしか理解していません。この記事では「ふんわりと理解すればいいや」という人向けにRustにおける`変性`について説明したいと思います。

:::message alert
私も完全に素人で勉強のためにアウトプットしているということなので、内容を信頼しすぎないようにお願いします。
:::

# `Variance(変性)`とは
[wikipedia](https://en.wikipedia.org/wiki/Covariance_and_contravariance_(computer_science))によると変性とは

>「より複雑な型の間のサブタイピングが、その構成要素の間のサブタイピングとどのように関連するかを意味する」

とあります。まずサブタイピングとはなにかという話ですが、これも[wikipdeia](https://ja.wikipedia.org/wiki/%E6%B4%BE%E7%94%9F%E5%9E%8B)を見ると

> サブタイピング（Subtyping）派生型とは、計算機科学またはプログラミング言語理論において、データ型S が他のデータ型T とis-a関係にあるとき、S をT の派生型（はせいがた、subtype）であるという。またT はS の基本型（きほんがた、supertype）であるという


とあります。JavaとかでいうCat型はAnimal型の特性をすべて持っているので、Cat型はAnimal型を継承するみたいな話がありますが、このときCat型はAnimal型のサブタイプと言えます。

次に構成要素とより複雑な型ですが、これはA型とB型が構成要素だとすると、AのリストとBのリスト、Aを引数にとる関数とBを引数にとる関数、これらがより複雑な型となります。
つまり、AとBがあるサブタイピングの関係を持っている時、AのリストとBのリスト、Aを引数にとる関数とBを引数にとる関数のサブタイピングの関係はどうなるんだい？という話です。

# なぜ`変性`を学ぶ必要があるのか
`変性`についてあまり聞き馴染みのない方もいるかもしれません。
こんなの知っている必要があるのか？と思うかもしれませんが、知っていると少しは役立つと思います。例えば以下のコードは合法でしょうか？

```rust
fn foo<'a>(s: &mut &'a str, x: &'a str) {
    *s = x;
}

#[test]
fn is_it_work() {
    let mut s: &'static str = "Hello, world";
    let x = "Bar".to_string(); 
    foo(&mut s, &x);
    assert_eq!(s, x);
}

```

答えは違法です。これは`&mut T`が`T`に対して`Invariace(反変)`であることが理由の１つです。コンパイルエラーになったら直せばいいがな！という人もいると思いますし、私もそれでいいと思いますが、なぜエラーになるのか訳を知りたいという人も少しはいると思うので、この記事ではRustにおける`Variance(変性)`について説明したいと思います。

# 記法とふんわりとした定義

## 定義
まず変性を定義しましょう。私は正確な定義はしりません。ここでは[Jan Gjengset](https://twitter.com/jonhoo)さんがおっしゃっていたふんわり定義を使うことにします。

:::message
AがBのサブタイプであるとはAは少なくともBと同じくらい便利ということである。
:::

例えば、Cat型はAnimal型のサブタイプですが、これはCat型はAnimal型ができることは何でもできるので、Cat型はAnimal型とすくなくとも同じくらい便利です。

## 記法
次に記法です。このような記法を使います。Rustには型とライフタイムにサブタイピングの関係があります。

:::message
AがBのサブタイプであるとき、AとBがライムタイムなら`A: B`と記述します。
:::

あとは以下の記法も導入しときます。

:::message
A、Bから構成された複雑な型をT<A>, T<B>と記述する。
:::

# 変性の種類
`変性`には`Invariance(不変性)`、`Covariance(共変性)`、`Contravariance(反変性)`、`Bivariance(双変性)`の4つがあります。この内`双変性`は、Rustでは私が見た記事の中には双変性である例がなかったので省略します。

# Covariance(共変性)
`共変`であるとは構成要素A, Bのサブタイピングの関係をより複雑な型T<A>とT<B>がそのまま引き継ぐということです。つまり

:::message
`A : BならばT<A> : T<B>`のとき共変である。
:::

といえます。Rustではほとんどのものは共変です。

## Rustにおける共変性
[この記事](https://doc.rust-lang.org/reference/subtyping.html)や[この記事](https://doc.rust-lang.org/nomicon/subtyping.html)に変性の表が載っているので見て欲しいですが、例えば`&'a T`はライムタイム`a`に対して`共変`です。また`Vec<T>`は`T`に対して`共変`です。以下のコードは有効です。

```rust
```


# Invariance(不変性)

## Rustにおける不変性

# Contravariance(双変性)

## Rustにおける反変性




# 参考文献
- https://www.youtube.com/watch?v=iVYWDIW71jk
- https://doc.rust-lang.org/nomicon/subtyping.html
- https://en.wikipedia.org/wiki/Covariance_and_contravariance_(computer_science)
- https://ja.wikipedia.org/wiki/%E6%B4%BE%E7%94%9F%E5%9E%8B
- https://qnighy.hatenablog.com/entry/2018/01/14/220000